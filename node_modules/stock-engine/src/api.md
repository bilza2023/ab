
# `ab-engine` — API Specification (v1)

A deterministic, event-sourced inventory engine.

The engine:

* Accepts `state`
* Accepts `command`
* Returns `newEvents[]`
* Never mutates state
* Never touches database
* Never performs I/O

---

# Core Concepts

Inventory is defined as:

> Sum of all `LEDGER` events grouped by `(mmaCode, supplierId, shade, size)`

Transport is defined as:

> Intent events (`DISPATCH`, `RECEIVE`, `CANCEL`) that coordinate ledger movements

---

# State Shape

```js
{
  ledger: LedgerEvent[],
  transport: TransportEvent[]
}
```

---

## LedgerEvent

```js
{
  type: 'LEDGER',
  mmaCode: string,
  supplierId: string,
  shade: string,
  size: string,
  qtyDelta: number,       // positive or negative
  reason: string,         // 'DEPOSIT' | 'WITHDRAW' | 'TRANSPORT' | 'REVERSAL' | custom
  linkId?: string|null,   // transportId if related
  meta?: object|null,
  ts: number              // unix timestamp (ms)
}
```

---

## TransportEvent

```js
{
  type: 'DISPATCH' | 'RECEIVE' | 'CANCEL',
  transportId: string,
  fromMmaCode: string,
  toMmaCode: string,
  supplierId: string,
  shade: string,
  size: string,
  qty: number,
  meta?: object|null,
  ts: number
}
```

---

# Engine API

All functions follow this contract:

```
fn(state, command) → Event[]
```

Where:

* `state` is immutable input
* `command` is validated input
* Return value is an array of new domain events

---

# Reads

## onHand

Returns current balance for a 4S bucket.

```js
onHand(state, {
  mmaCode,
  supplierId,
  shade,
  size
}) → number
```

---

# Commands

---

## deposit

Creates a positive ledger event.

### Input

```js
deposit(state, {
  toMmaCode: string,
  supplierId: string,
  shade: string,
  size?: string,
  qty: number,
  reason?: string,   // default 'DEPOSIT'
  meta?: object|null,
  ts: number
})
```

### Returns

```js
[
  {
    type: 'LEDGER',
    mmaCode,
    supplierId,
    shade,
    size,
    qtyDelta: +qty,
    reason,
    linkId: null,
    meta,
    ts
  }
]
```

---

## withdraw

Creates a negative ledger event.

Validates sufficient balance.

### Input

```js
withdraw(state, {
  fromMmaCode: string,
  supplierId: string,
  shade: string,
  size?: string,
  qty: number,
  reason?: string,   // default 'WITHDRAW'
  meta?: object|null,
  ts: number
})
```

### Returns

```js
[
  {
    type: 'LEDGER',
    mmaCode,
    supplierId,
    shade,
    size,
    qtyDelta: -qty,
    reason,
    linkId: null,
    meta,
    ts
  }
]
```

Throws if insufficient balance.

---

## dispatch

Creates transport intent and negative ledger entry.

Validates sufficient balance.

### Input

```js
dispatch(state, {
  transportId: string,
  fromMmaCode: string,
  toMmaCode: string,
  supplierId: string,
  shade: string,
  size?: string,
  qty: number,
  meta?: object|null,
  ts: number
})
```

### Returns

```js
[
  {
    type: 'DISPATCH',
    transportId,
    fromMmaCode,
    toMmaCode,
    supplierId,
    shade,
    size,
    qty,
    meta,
    ts
  },
  {
    type: 'LEDGER',
    mmaCode: fromMmaCode,
    supplierId,
    shade,
    size,
    qtyDelta: -qty,
    reason: 'TRANSPORT',
    linkId: transportId,
    ts
  }
]
```

---

## receive

Completes a dispatch.

Validates:

* DISPATCH exists
* not already received
* not canceled

### Input

```js
receive(state, {
  transportId: string,
  ts: number
})
```

### Returns

```js
[
  {
    type: 'RECEIVE',
    transportId,
    fromMmaCode,
    toMmaCode,
    supplierId,
    shade,
    size,
    qty,
    ts
  },
  {
    type: 'LEDGER',
    mmaCode: toMmaCode,
    supplierId,
    shade,
    size,
    qtyDelta: +qty,
    reason: 'TRANSPORT',
    linkId: transportId,
    ts
  }
]
```

Returns `[]` if idempotent.

---

## cancel

Reverses a dispatch that has not been received.

Validates:

* DISPATCH exists
* not already received
* not already canceled

### Input

```js
cancel(state, {
  transportId: string,
  ts: number
})
```

### Returns

```js
[
  {
    type: 'CANCEL',
    transportId,
    fromMmaCode,
    toMmaCode,
    supplierId,
    shade,
    size,
    qty,
    ts
  },
  {
    type: 'LEDGER',
    mmaCode: fromMmaCode,
    supplierId,
    shade,
    size,
    qtyDelta: +qty,
    reason: 'REVERSAL',
    linkId: transportId,
    ts
  }
]
```

Returns `[]` if idempotent.

---

# Engine Guarantees

* Append-only
* Deterministic
* Idempotent (receive, cancel)
* No side effects
* No persistence
* No I/O
* No DB dependency
* No station validation
* No supplier validation

---

# Repository Responsibility

The repository layer must:

1. Load relevant history into `state`
2. Call engine
3. Persist returned events
4. Merge events into state

Engine does not handle:

* Pagination
* Date filtering
* Snapshots
* Transactions
* UUID generation

---

# Determinism Rule

For full determinism:

* `ts` must be provided by caller
* `transportId` must be provided by caller

Engine does not generate randomness.

